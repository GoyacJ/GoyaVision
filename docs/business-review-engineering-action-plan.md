# GoyaVision 业务复盘（研发落地版）

## 1. 文档目标

把复盘结论转换成研发可执行动作，回答三件事：

1. 先修什么。  
2. 怎么验收。  
3. 按什么节奏推进。

适用日期：2026-02-08。

## 2. 现状基线

已具备：

- 资产、算子、工作流、任务、产物核心域模型。  
- DAG 执行引擎（并行、重试、超时、节点追踪、上下文）。  
- 调度器（手动、定时、事件）与事件总线接入。  
- 算法库、Agent Run Loop、AI 模型中心基础能力。

主要问题：

- 业务闭环不完整（调度联动、事件发布、任务入口语义）。  
- 前后端契约不一致（状态枚举、返回体结构、文档覆盖）。  
- 商业化链路与执行链路耦合较弱。  
- 多租户策略在个别仓储实现中口径不统一。

## 3. 整改优先级

## 3.1 P0（第一优先，先做）

1. 统一工作流状态字典  
后端状态作为单一真相，前端与 API 类型全部对齐。  
验收：状态筛选、标签、启停按钮与后端返回一致。

2. 启停与调度实时联动  
工作流 enable/disable 时即时调度/取消调度，不依赖重启或被动回收。  
验收：启用后可在 1 个调度周期内触发；禁用后不再创建新任务。

3. 任务执行入口语义统一  
明确 `/tasks/:id/start` 是执行入口还是仅状态管理；避免与 workflow trigger 双轨混淆。  
验收：对外文档、前端按钮、后端行为三者一致。

## 3.2 P1（高优先，紧接执行）

1. 补齐 `asset_done` 事件发布链路  
在资产“真正就绪”节点统一发布事件。  
验收：`asset_done` 触发型工作流可稳定命中并执行。

2. API 契约一致化  
统一响应封装策略（envelope 或 plain 二选一），前端解包逻辑收敛。  
验收：API 客户端不再出现多种解包分支。

3. 文档与路由自动校验  
建立“路由变更即校验文档”的 CI 门禁。  
验收：新增/删改接口必须更新 `docs/api.md`。

4. 支付回调链路闭环  
回调路由、验签、订单状态、余额更新、幂等等完成端到端闭环。  
验收：回调压测下到账一致率与幂等一致率达标。

5. user_asset 租户策略收敛  
明确其是否是全局用户域；若不是，补齐租户 scope。  
验收：跨租户场景下读写边界符合预期。

## 3.3 P2（中优先，提升体验与稳定）

1. 编辑器连线门禁增强  
在编辑阶段接入后端兼容性校验，减少运行时失败。  
验收：不兼容连线在编辑期可被阻止并提示原因。

2. 观测与告警增强  
按任务/节点输出结构化失败原因和耗时分位指标。  
验收：可在一个页面定位大多数失败根因。

## 4. 推荐迭代节奏（3 个 Sprint）

### Sprint 1（2 周）闭环核心

- 状态字典统一。  
- 启停调度联动。  
- 任务入口语义统一。  
- 文档补齐缺失接口。

交付标准：

- 前端工作流页面状态行为与后端一致。  
- Enable/Disable 对调度效果可测可复现。  
- 关键 API 文档覆盖率达到 100%（以路由扫描为准）。

### Sprint 2（2 周）事件与契约

- `asset_done` 发布链路补齐。  
- API 返回格式统一。  
- 前端统一解包工具。  
- 补集成测试。

交付标准：

- 事件触发工作流成功率稳定。  
- 前端接口层无多套解析逻辑。  
- 集成测试覆盖手动/定时/事件三类触发。

### Sprint 3（2 周）商业化与治理

- 支付回调闭环与幂等。  
- user_asset 边界收敛。  
- 计量策略与任务消耗挂钩（最小可用版）。

交付标准：

- 回调链路通过端到端测试。  
- 多租户策略边界明确并可验证。  
- 至少一条“调用即计量”的业务链路上线。

## 5. 验收清单（建议纳入 DoD）

每项改造完成前需满足：

1. 单元测试通过。  
2. 集成测试覆盖关键主链路。  
3. API 文档同步更新。  
4. 前端页面回归通过（状态、触发、详情页）。  
5. 日志与监控字段可观测（workflow_id、task_id、node_key、error_code）。

## 6. 风险与对策

1. 风险：并行改造导致状态口径再次分裂。  
对策：先冻结状态字典，建立枚举单源定义。

2. 风险：回调与计量改造引入资金一致性问题。  
对策：所有资金类写操作必须幂等并可重放。

3. 风险：文档更新滞后复发。  
对策：把文档校验前置到 CI，不通过则禁止合并。

## 7. 完成标志

当以下条件同时满足，可判定复盘整改完成：

1. 三类触发（manual/schedule/event）均稳定可用。  
2. 状态语义与 API 契约前后端一致。  
3. 文档与实现一致性纳入流程化治理。  
4. 商业化链路具备最小闭环能力。  

---

最后更新：2026-02-08
